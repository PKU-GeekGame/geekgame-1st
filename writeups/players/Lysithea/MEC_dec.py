import binascii
from rsa import *
import socket



def MEC_getPub4(msg:str, cip:str):
    # only use the head, or 1 frame
    pmess = msg[0:32].encode('utf-8')
    cip = binascii.unhexlify(cip[0:64])
    # forward
    a = bytes_to_long(pmess[0:8])
    b = bytes_to_long(pmess[8:16])
    c = bytes_to_long(pmess[16:24])
    d = bytes_to_long(pmess[24:32])
    for i in range(32):
        a, b, c, d = b, c, d, a ^ c
    # backward
    ca = bytes_to_long(cip[0:8])
    cb = bytes_to_long(cip[8:16])
    cc = bytes_to_long(cip[16:24])
    cd = bytes_to_long(cip[24:32])
    return (ca^a, cb^b, cc^c, cd^d)

def MECdec(cip_b16:str, pub4:tuple):
    cip = binascii.unhexlify(cip_b16)
    pa,pb,pc,pd = pub4
    msg = b''
    for it in range(0, len(cip), 32):
        pcip = cip[it:it+32]
        b=bytes_to_long(pcip[0:8]) ^ pa
        c=bytes_to_long(pcip[8:16]) ^ pb
        d=bytes_to_long(pcip[16:24]) ^ pc
        ac=bytes_to_long(pcip[24:32]) ^ pd
        for i in range(32):
            b,c,d,ac = ac^c,b,c,d
        a,b,c,d = b,c,d,ac
        a=long_to_bytes(a,8)
        b=long_to_bytes(b,8)
        c=long_to_bytes(c,8)
        d=long_to_bytes(d,8)
        msg+=a+b+c+d
    return msg



rmsg1 = 'Hello, Alice! I will give you two flags. The first is: '
rcip = 'bb4ceea82f479f4bcc0bf7711e5bfc6870ba177b73df9b5abf9d303ce8914bb5bf51a2ad7c1ad65bc54ae9652d1eb94c53e2517e2ec98125fae12528da922ec39364ec9b4077b040a1238616637380174492357b1da6c0678eae4961dafc4d8e'



pub4 = MEC_getPub4(rmsg1, rcip)
msg = unpad(MECdec(rcip, pub4)).decode()
print(msg)



# name = ('Alice','Richard')
# print(binascii.hexlify(name[0].encode('utf-8')), binascii.hexlify(name[1].encode('utf-8')))

# N = 25865305011736185579876780000513673023990115817763332753749748728466110843819056841946086101670926163122341928891643120649324200184910154340042764479547722666066167894652859634679209412258932361757133486160046139167542511924941480315901486943492406958340326733863896630754214529663626382649943924684752949622843161151187019945818588235205932081037019759708482654193876584891549058976943808522826230142685782020655725575671801189836650985755512260987278418193328794126043648383518877635390047888577391365419862898532154897043053156351122868300791266902533001984346111921411470669714822246210974327111456994440230385449
# e = 65537
# mycert = 3595677083775446914133680376145646210253105905430138455093082542647753978468154077718186985299089756465348129282019421960940381288176835421474526723398836885963086430595952820140691856400348912189748782096225648207894340315503352309492273711481144999537085320411688937280112270263752999433891578100566541748398476023194518578581568170397099632656946729926611128749858457513066251105930951443958125949406058523149833700864483675182655718468238594316344158986657603549368241559122046135712551169643346428016741860985497869584083943688030458005400144221284757404561248994682864860995327285926126272869998099472955724507

# print(dec(mycert))
# rsa_key = (N,e)